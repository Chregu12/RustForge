groups:
  - name: rustforge_alerts
    interval: 30s
    rules:
      # Command Execution Alerts
      - alert: HighCommandErrorRate
        expr: rate(rustforge_commands_failed_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: commands
        annotations:
          summary: "High command error rate detected"
          description: "Command {{ $labels.command_name }} has error rate of {{ $value | humanizePercentage }} (threshold: 5%)"

      - alert: SlowCommandExecution
        expr: histogram_quantile(0.95, rate(rustforge_command_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
          component: commands
        annotations:
          summary: "Slow command execution detected"
          description: "Command {{ $labels.command_name }} p95 latency is {{ $value }}s (threshold: 10s)"

      # HTTP Request Alerts
      - alert: HighHTTPErrorRate
        expr: |
          sum(rate(rustforge_http_requests_total{status=~"5.."}[5m]))
          /
          sum(rate(rustforge_http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          component: http
        annotations:
          summary: "High HTTP 5xx error rate"
          description: "HTTP 5xx error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      - alert: SlowHTTPRequests
        expr: histogram_quantile(0.95, rate(rustforge_http_request_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: http
        annotations:
          summary: "Slow HTTP requests detected"
          description: "HTTP {{ $labels.method }} {{ $labels.path }} p95 latency is {{ $value }}s (threshold: 5s)"

      - alert: TooManyRequestsInFlight
        expr: rustforge_http_requests_in_flight > 100
        for: 2m
        labels:
          severity: warning
          component: http
        annotations:
          summary: "Too many concurrent HTTP requests"
          description: "{{ $value }} requests currently in flight (threshold: 100)"

      # Database Alerts
      - alert: DatabaseConnectionPoolExhausted
        expr: rustforge_db_connections_idle < 2
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Only {{ $value }} idle database connections available"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(rustforge_db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Slow database queries detected"
          description: "Database {{ $labels.operation }} p95 latency is {{ $value }}s (threshold: 1s)"

      # Cache Alerts
      - alert: LowCacheHitRate
        expr: |
          rate(rustforge_cache_hits_total[5m])
          /
          (rate(rustforge_cache_hits_total[5m]) + rate(rustforge_cache_misses_total[5m])) < 0.5
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache {{ $labels.cache_name }} hit rate is {{ $value | humanizePercentage }} (threshold: 50%)"

      # Queue Alerts
      - alert: QueueBacklogBuilding
        expr: rustforge_queue_size > 1000
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Queue backlog building up"
          description: "Queue {{ $labels.queue_name }} has {{ $value }} messages pending (threshold: 1000)"

      - alert: QueueBacklogCritical
        expr: rustforge_queue_size > 10000
        for: 2m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Critical queue backlog"
          description: "Queue {{ $labels.queue_name }} has {{ $value }} messages pending (threshold: 10000)"

      # Application Health Alerts
      - alert: ApplicationDown
        expr: up{job="rustforge"} == 0
        for: 1m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "RustForge application is down"
          description: "Application instance {{ $labels.instance }} is not responding"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes > 1073741824
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High memory usage"
          description: "Application using {{ $value | humanize1024 }}B of memory (threshold: 1GB)"

      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"

      # Error Rate Alerts
      - alert: HighErrorRate
        expr: rate(rustforge_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }}/s in {{ $labels.component }} (threshold: 10/s)"

  - name: rustforge_recording_rules
    interval: 30s
    rules:
      # Recording rules for frequently used queries
      - record: job:rustforge_http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, rate(rustforge_http_request_duration_seconds_bucket[5m]))

      - record: job:rustforge_http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, rate(rustforge_http_request_duration_seconds_bucket[5m]))

      - record: job:rustforge_command_duration_seconds:p95
        expr: histogram_quantile(0.95, rate(rustforge_command_duration_seconds_bucket[5m]))

      - record: job:rustforge_http_requests:rate5m
        expr: rate(rustforge_http_requests_total[5m])

      - record: job:rustforge_http_errors:rate5m
        expr: rate(rustforge_http_requests_total{status=~"5.."}[5m])

      - record: job:rustforge_cache_hit_rate:ratio
        expr: |
          rate(rustforge_cache_hits_total[5m])
          /
          (rate(rustforge_cache_hits_total[5m]) + rate(rustforge_cache_misses_total[5m]))
